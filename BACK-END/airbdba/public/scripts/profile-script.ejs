<script>
  $(document).ready(() => {
    /* LETs & CONSTs */
    let $image = $("#image");

    /* --------------------------------------------------------- */
    /* ON REFRESH */
    // Modifico la navbar modificando l'opzione profilo,
    // ridondante in quanto riporta alla stessa pagina
    // e la trasformo nell'opzione "Home"
    $(".profile-nav").attr("href", "/").text("Home");

    $("#imgupload").val("");
    $("#profile-pic").css({
      "background-image": `
        <% if ( user.imagePath ) { %>
          url("<%= user.imagePath.slice(user.imagePath.indexOf("uploads")) %>")
        <% } else { %>
          url("assets/images/profile_pics/profile-placeholder.png")
        <% }%>
        `,
    });
    /* --------------------------------------------------------- */

    /* CROPPER */
    // Mostro il modal contenente il cropper
    function readURL(input) {
      if (input.files && input.files[0]) {
        let reader = new FileReader();

        reader.onload = function (e) {
          console.log(e.target.result);
          $image.cropper("destroy");
          $image.attr("src", "");
          $image.attr("src", e.target.result);
          $image.cropper({
            aspectRatio: 1 / 1,
            minContainerWidth: 300,
            minContainerHeight: 300,
            crop: function (event) {
              console.log(event.detail.x);
              console.log(event.detail.y);
              console.log(event.detail.width);
              console.log(event.detail.height);
              console.log(event.detail.rotate);
              console.log(event.detail.scaleX);
              console.log(event.detail.scaleY);
            },
          });
        };

        reader.readAsDataURL(input.files[0]); // convert to base64 string
      }
    }

    $("#image-crop").on("hidden.bs.modal", function (e) {
      $image.cropper("destroy");
      $image.attr("src", "");
      $("#imgupload").val("");
      console.log($("#imgupload").val());
    });

    $("#imgupload").on("change", function () {
      readURL(this);
    });

    $("#edit-avatar").on("click", () => {
      $("#image-crop").modal("show");
    });

    $("#OpenImgUpload").on("click", function () {
      $("#imgupload").trigger("click");
    });

    /* --------------------------------------------------------- */

    /* OPERAZIONE DI FETCH */
    $("#save-avatar").on("submit", (e) => {
      e.preventDefault();
      if ($("#imgupload").val() === "") {
        return;
      }

      $image.cropper("getCroppedCanvas").toBlob((blob) => {
        const formData = new FormData();
        formData.append("avatar", blob, "<%= user.id %>.png");
        console.log(formData.get("avatar"));

        fetch("/profilo/modifica-foto/avatarUtente/<%= user.id %>", {
          method: "PUT",
          body: formData,
        })
          .then(async (res) => {
            const response = await res.json();
            if (response.success) {
              console.log("caricamento effettuato");
              $("#image-crop").modal("hide");
              $("#profile-pic").css({
                "background-image": `
                  <% if ( user.imagePath ) { %>
                      url("<%= user.imagePath.slice(user.imagePath.indexOf("uploads")) %>")
                  <% } else { %>
                      url("assets/images/profile_pics/profile-placeholder.png")
                  <% }%>
                  `,
              });
              window.location.reload();
            }
          })
          .catch((err) => console.log(err));
      }, "image/png");
    });
    /* --------------------------------------------------------- */
  });
</script>
