<script>
  $(document).ready(() => {
    /* Vars */
    const imgToDel = [];
    let folderPath = "";

    /* ON RELOAD */
    bsCustomFileInput.init();
    if ($(window).width() < "448") {
      $("#visualizza-tab").text("Visualizza");
      $("#aggiungi-tab").text("Aggiungi");
    } else {
      $("#visualizza-tab").text("Visualizza inserzioni");
      $("#aggiungi-tab").text("Aggiungi inserzione");
    }
    /* ------------------------------------------------- */

    /* INPUT FILE */
    $("#inputFile").on("change", () => {
      $("#inputFileLabel").text(() => {
        return "ciao";
      });
    });

    /* DATEPICKER */
    $("#inputInit, #inputFin").datepicker({
      format: "yyyy-mm-dd",
      autoclose: true,
      todayHighlight: true,
      startDate: new Date(),
    });

    /* CHECKBOXES */
    // initial value
    $("#casa, #casaModal").prop("checked", true);
    $("#bnb, #bnbModal").prop("checked", false);

    $("#casa, #casaModal").on("click", function () {
      if ($("#bnb, #bnbModal").prop("checked")) {
        $("#bnb, #bnbModal").prop("checked", false);
      } else {
        $(this).prop("checked", true);
      }
    });
    $("#bnb, #bnbModal").on("click", function () {
      if ($("#casa, #casaModal").prop("checked")) {
        $("#casa, #casaModal").prop("checked", false);
      } else {
        $(this).prop("checked", true);
      }
    });
    /* ------------------------------------------------- */

    /* VISUALIZZA INSERZIONI */
    const inserzioni = JSON.parse("<%= inserzioni %>".replace(/&#34;/g, '"'));

    const immagini = {};
    inserzioni.forEach((inserzione, index) => {
      immagini[`${index}`] = inserzione.galleryPath.split(",");
    });

    if (inserzioni.length === 0) {
      $("#visualizza").append(`
          <div class="row justify-content-center align-items-center">
            <div class="col-10">
              <p class="text-justify">
                Non hai ancora nessuna inserzione. Vai su <u>Aggiungi inserzione</u> per iniziare!!
                <br>
              </p>
              <img src="/assets/images/notFound.png" style="width:100%; opacity:.35; margin-top: 30px">
            </div>
          </div>
        `);
    } else {
      // modificare il for each
      inserzioni.forEach((inserzione, index) => {
        $("#visualizza").append(`
          <div class="row">
            <div class="col-12">
              <div class="card add-margin">
                <div class="card-body no-padding">
                  <div class="row">
                    <div class="col-md-12 col-lg-4">
                      <img src="/uploads/fotoInserzione/<%= user.id %>${
                        immagini[index][0]
                      }" class="card-i" alt="img" style="width:100%">
                    </div>
                    <div class="col-md-12 col-lg-8 add-padding">
                      <b>${inserzione.nome_inserzione}</b>
                      <p>
                        <i>${
                          inserzione.citta[0].toUpperCase() +
                          inserzione.citta.slice(1)
                        }, ${inserzione.indirizzo}</i>
                        <br>
                        ${inserzione.inizioDisponibilita}&nbsp;
                        ${inserzione.fineDisponibilita}
                        <br>
                        ${inserzione.n_ospiti} ospiti,&nbsp;
                        ${inserzione.prezzo_base}&euro; x notte
                      </p>
                    </div>
                  </div>
                </div>
                <div class="card-footer inserzione-footer">
                  <button
                    id="${index}"
                    inserzione="${index}"
                    class="btn btn-primary mod"
                  >
                    Modifica
                  </button>
                  <button
                    inserzione="${inserzione.id_inserzione}"
                    class="btn btn-danger del"
                  >
                    Elimina
                  </button>
                </div>
              </div>
            </div>
          </div>
        `);

        // Modifica inserzione
        $(`button#${index}`).on("click", function () {
          $("#insMod")
            .attr("index", index)
            .attr("inserzione", inserzione.id_inserzione)
            .on("show.bs.modal", function () {
              // Salvo il path della cartella
              folderPath = immagini[index][0].slice(0, 14);
              console.log(folderPath);

              // Compilo i campi dell'inserzione con i valori attuali
              $("#inputTitoloModal").val(inserzione.nome_inserzione);
              $("#inputCityModal").val(inserzione.citta);
              $("#inputInitModal").val(inserzione.inizioDisponibilita);
              $("#inputFinModal").val(inserzione.fineDisponibilita);
              $("#inputOspitiModal").val(inserzione.n_ospiti);
              $("#inputDescModal").val(inserzione.descrizione);
              $("#inputPriceModal").val(inserzione.prezzo_base);
              $("#inputTassaModal").val(inserzione.tassa_soggiorno);
              // Dato che l'indirizzo Ã¨ nel formato "Via Roma 18"
              // devo prelevare il numero civico poi prendere il resto
              // della stringa.

              // Divido la stringa in base agli spazi
              // ["Via", "Roma", "18"]
              const ind = inserzione.indirizzo.split(" ");
              $("#inputNumModal").val(ind[ind.length - 1]);

              // Rimuovo il numero civico
              // ["Via", "Roma"]
              ind.pop();

              // Concateno i valori
              // "Via Roma"
              const via = ind.reduce((x, y) => x + " " + y);
              $("#inputAddressModal").val(via);

              // Inserisco un avviso sul campo per inserire le immagini
              $("#customFileModalLabel").text(
                `Solo altre ${10 - immagini[index].length}`
              );

              // TODO
              /* $("#customFileModalLabel").on("click", function () {
                console.log($(this).prop("files"));
              }); */

              /* Attivo anche le checkbox dei servizi in modo corretto */
              let serviziKeys = Object.keys(inserzione.servizi);
              for (let j = 1; j < serviziKeys.length - 1; j += 1) {
                let servizio = serviziKeys[j].slice(
                  0,
                  serviziKeys[j].length - 4
                );
                if (inserzione.servizi[serviziKeys[j]]) {
                  $(`#${servizio}Modal`).prop("checked", true);
                } else {
                  $(`#${servizio}Modal`).prop("checked", false);
                }
              }

              for (let i = 0; i < immagini[index].length; i += 1) {
                $(`.img${i}`)
                  .css({
                    display: "flex",
                    "background-image": `url("/uploads/fotoInserzione/<%= user.id %>${immagini[index][i]}")`,
                    "background-size": "cover",
                    "background-position": "center",
                    height: "200px",
                    opacity: 1,
                  })
                  .attr("path", immagini[index][i])
                  .on("click", function () {
                    imgToDel.push($(this).attr("path"));
                    console.log(imgToDel);
                    $(this).animate({ opacity: 0 }, 125, function () {
                      $(this).css({
                        "background-image": "none",
                        display: "none",
                      });
                    });
                  });
              }
            })
            .on("hidden.bs.modal", function () {
              for (let i = 0; i < immagini[index].length; i += 1) {
                $(`.img${i}`).removeAttr("style path").off("click");
                $("#customFileModalLabel").off("click");
                $("#insMod").off("show.bs.modal hidden.bs.modal");
              }
              while (imgToDel.length > 0) {
                imgToDel.pop();
                console.log(imgToDel);
              }
            })
            .modal("show");
        });
      });
    }
    /* ------------------------------------------------- */

    /* CONTROLLI */
    /* $("input").each((index, element) => {
      $(element)
    }); */

    /* ------------------------------------------------- */

    /* AGGIUNGI INSERZIONE */
    $("form").on("submit", (e) => {
      e.preventDefault();

      let servizi = {};
      $("input[type=checkbox]").each((index, element) => {
        if ($(element).prop("checked")) {
          servizi[$(element).prop("id")] = 1;
        } else {
          servizi[$(element).prop("id")] = 0;
        }
      });

      const formData = new FormData();
      const images = $("input[type=file][multiple].inputFileNormal").prop(
        "files"
      );

      for (let i = 0; i < images.length; i++) {
        formData.append("gallery", images[i]);
      }

      const ins = JSON.stringify({
        nome: $("#inputTitolo").val(),
        citta: $("#inputCity").val(),
        inizioDisp: $("#inputInit").val(),
        fineDisp: $("#inputFin").val(),
        nospiti: $("#inputOspiti").val(),
        desc: $("#inputDesc").val(),
        indirizzo: $("#inputAddress").val() + " " + $("#inputNum").val(),
        prezzo: $("#inputPrice").val(),
        tassa: $("#inputTassa").val(),
        servizi,
      });

      formData.append("inserzione", ins);

      fetch(`/host/crea_ins/fotoInserzione/<%= user.id %>/${Date.now()}`, {
        method: "PUT",
        body: formData,
      })
        .then(async (res) => {
          const response = await res.json();
          if (response.success) {
            console.log("Caricamento completato!");
            window.location.reload();
          }
        })
        .catch((err) => console.log(err));
    });
    /* ------------------------------------------------- */

    /* MODIFICA INSERZIONE */
    // Array che contiene i nomi delle immagini che vanno eliminate

    $("#saveChanges").on("click", () => {
      // Sottraggo dalla lista di tutte le immagini, quelle rimosse
      // dall'utente
      const imgToSave = immagini[$("#insMod").attr("index")].filter((x) => {
        return !imgToDel.includes(x);
      });

      // Creo un arrai per i servizi
      let servizi = {};
      $(`input[type=checkbox][id$="Modal"]`).each((index, element) => {
        if ($(element).prop("checked")) {
          servizi[$(element).prop("id")] = 1;
        } else {
          servizi[$(element).prop("id")] = 0;
        }
      });

      console.log(immagini[$("#insMod").attr("index")], imgToDel, imgToSave);

      const formData = new FormData();
      const images = $("input[type=file][multiple][id$='Modal']").prop("files");

      for (let i = 0; i < images.length; i++) {
        formData.append("gallery", images[i]);
      }

      const insModal = JSON.stringify({
        nome: $("#inputTitoloModal").val(),
        citta: $("#inputCityModal").val(),
        inizioDisp: $("#inputInitModal").val(),
        fineDisp: $("#inputFinModal").val(),
        nospiti: $("#inputOspitiModal").val(),
        desc: $("#inputDescModal").val(),
        indirizzo:
          $("#inputAddressModal").val() + " " + $("#inputNumModal").val(),
        prezzo: $("#inputPriceModal").val(),
        tassa: $("#inputTassaModal").val(),
        servizi,
        imgToSave,
        imgToDel,
        id_ins: $("#insMod").attr("inserzione"),
      });

      console.log(insModal);

      formData.append("inserzione", insModal);

      fetch(`/host/modifica/fotoInserzione/<%= user.id %>${folderPath}`, {
        method: "PUT",
        body: formData,
      })
        .then(async (res) => {
          const response = await res.json();
          if (response.success) {
            console.log("Caricamento completato!");
            window.location.reload();
          }
        })
        .catch((err) => console.log(err));
    });

    /* ------------------------------------------------- */

    /* ELIMINA INSERZIONE */
    $(".del").on("click", function () {
      $(".confirm").attr("inserzione", $(this).attr("inserzione"));
      $("#confirmDel").modal("show");
    });
    $(".confirm").on("click", function () {
      const id_inserzione = $(this).attr("inserzione");
      fetch("/host/delete_ins", {
        method: "DELETE",
        body: JSON.stringify({ id_inserzione }),
        headers: { "Content-Type": "application/json" },
      })
        .then(async (res) => {
          const response = await res.json();
          if (response.success) {
            window.location.reload();
          }
        })
        .catch((err) => console.log(err));
    });

    /* ------------------------------------------------- */

    $(window).resize(() => {
      if ($(window).width() < "448") {
        $("#visualizza-tab").text("Visualizza");
        $("#aggiungi-tab").text("Aggiungi");
      } else {
        $("#visualizza-tab").text("Visualizza inserzioni");
        $("#aggiungi-tab").text("Aggiungi inserzione");
      }
    });
  });
</script>
